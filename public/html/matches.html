<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Blog - Express</title>
    <!-- Latest compiled and minified CSS & JS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootswatch/4.0.0/flatly/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css" media="screen" title="no title">
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</head>

<body>
    <div class="container">
        <form>
            <div class="form-group">
                <label for="locationFilter">Only show users within this many miles from me:</label>
                <select multiple class="form-control" id="locationFilter">
                    <option>10</option>
                    <option>20</option>
                    <option>30</option>
                    <option>40</option>
                    <option>50</option>
                </select>
            </div>
        </form>
        <div class="row">
            <h1>My matches:</h1>
            <div class="col-md-12 blog-container">
            </div>
        </div>
    </div>
    <!-- Custom Script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.0/moment.min.js" type="text/javascript"></script>

</body>

<script>

    $(document).ready(function () {

        $("option").on("click", function () {
            var radius = $("#locationFilter").val();
            radius = radius[0];
            console.log("radius: " + radius);
            var zip = sessionStorage.getItem("zip");
            console.log("zip: " + zip);
            
            var queryURL = "https://api.zip-codes.com/ZipCodesAPI.svc/1.0/FindZipCodesInRadius?zipcode=" + zip + "&minimumradius=0&maximumradius=" + radius + "&key=Y23J3P9U38KMS91SX4TK";
            // Creating an AJAX call to find array of all zip codes within the radius specified
            $.ajax({
                url: queryURL,
                method: "GET"
            }).then(function (resObj) {
                var filteredPosts = [];

                var holdData;

                var arrayOfCities = resObj.DataList;

                var zipCodeArray = arrayOfCities.map(a => a.Code);
                
                for (let i = 0; i < zipCodeArray.length; i++ ) {
                    var matchZip = zipCodeArray[i];
                    $.get("/api/users/zip/" + matchZip + "", function (data) {
                        console.log(data);
                        holdData = data;
                    })
                };

                if (!filteredPosts || !filteredPosts.length) {
                    displayEmpty();
                }
                else {
                    initializeRows(filteredPosts);
                }
            });
            });
            

        

        // blogContainer holds all of our posts
        var blogContainer = $(".blog-container");

        // Click events for the edit and delete buttons

        // This function grabs posts from the database and updates the view
        function getPosts() {
            $.get("/api/users", function (data) {
                
                if (!data || !data.length) {
                    displayEmpty();
                }
                else {
                    initializeRows(data);
                }
            });
        }

        // Getting the initial list of posts
        getPosts();
        // InitializeRows handles appending all of our constructed post HTML inside
        // blogContainer
        function initializeRows(posts) {
            blogContainer.empty();
            var postsToAdd = [];
            for (var i = 0; i < posts.length; i++) {
                postsToAdd.push(createNewRow(posts[i]));
            }
            blogContainer.append(postsToAdd);
        }

        // This function constructs a post's HTML
        function createNewRow(post) {
            var newPostCard = $("<div>");
            newPostCard.addClass("card");


            var newPostName = $("<p>");
            var newPostGender = $("<p>");
            var newPostAge = $("<p>");
            var newPostEmail = $("<p>");
            var newPostBio = $("<p>");
            var newPostHobbies = $("<p>");

            newPostName.text("Name: " + post.username);
            newPostGender.text("Gender: " + post.gender);
            newPostAge.text("Gender: " + post.age);
            newPostEmail.text("Email: " + post.email);
            newPostBio.text("Bio: " + post.bio);
            newPostHobbies.text("Hobbies: " + post.hobbies);

            newPostCard.append(newPostName);
            newPostCard.append(newPostGender);
            newPostCard.append(newPostAge);
            newPostCard.append(newPostEmail);
            newPostCard.append(newPostBio);
            newPostCard.append(newPostHobbies);
            newPostCard.data("post", post);
            return newPostCard;
        }

        // This function displays a message when there are no posts
        function displayEmpty() {
            blogContainer.empty();
            var messageH2 = $("<h2>");
            messageH2.css({ "text-align": "center", "margin-top": "50px" });
            messageH2.html("No users yet.");
            blogContainer.append(messageH2);
        }

    });

</script>

</html>